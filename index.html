<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Cloud Inventory Pro</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#2563eb">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Inventory Pro","short_name":"InvPro","start_url":".","display":"standalone","background_color":"#ffffff","theme_color":"#2563eb","icons":[{"src":"icon.png","sizes":"512x512","type":"image/png"}]}'>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --success: #22c55e; --bg: #f1f5f9; --admin: #7c3aed; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 10px; padding-bottom: 90px; -webkit-tap-highlight-color: transparent; }
        * { user-select: none; -webkit-user-select: none; }
        input, select { user-select: text; -webkit-user-select: text; }

        /* Auth Screen */
        #auth-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:10000; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:30px; box-sizing:border-box; text-align:center; }

        /* Splash Screen */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-top: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* General UI */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 15px; }
        h2 { font-size: 1rem; margin-top: 0; color: #1e293b; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: opacity 0.2s; }
        .btn-post { background: var(--success); height: 55px; font-size: 1.1rem; }
        .admin-badge { background: #f3e8ff; color: var(--admin); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; }
        
        /* Navigation */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; display: flex; border-top: 1px solid #e2e8f0; height: 75px; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; text-align: center; padding-top: 15px; font-size: 0.75rem; color: #64748b; }
        .nav-item.active { color: var(--primary); font-weight: bold; border-top: 3px solid var(--primary); }
        .tab-content { display: none; padding-top: 10px; }
        .tab-content.active { display: block; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px 5px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        
        /* Activity List Styling */
        .hist-group { background: white; border-left: 5px solid var(--success); padding: 12px; margin-bottom: 10px; border-radius: 8px; position: relative; }
        .user-tag { font-size: 0.65rem; background: #e2e8f0; color: #475569; padding: 2px 6px; border-radius: 10px; font-weight: bold; position: absolute; top: 12px; right: 12px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <img src="icon.png" style="width:120px; border-radius:20px; margin-bottom:20px;">
        <h2>Inventory Login</h2>
        <input type="email" id="auth-email" placeholder="Email Address">
        <input type="password" id="auth-pass" placeholder="Password">
        <button onclick="handleAuth()">Login / Sign Up</button>
    </div>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Syncing Warehouse...</p>
    </div>

    <h1 style="text-align:center; font-size: 1.1rem; color: var(--primary); margin: 10px 0;">
        Cloud Inventory Pro <span id="admin-indicator" style="display:none;" class="admin-badge">ADMIN</span>
    </h1>

    <div id="tab-dash" class="tab-content active">
        <div class="card">
            <h2 id="dash-title">Inventory Levels</h2>
            <input type="text" id="searchInput" placeholder="Search items..." onkeyup="render()">
            <table>
                <thead><tr><th>Item</th><th>Qty</th><th>Stat</th></tr></thead>
                <tbody id="invTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="tab-move" class="tab-content">
        <div class="card">
            <h2 id="nextBatchDisplay">Batch #----</h2>
            <input type="text" id="moveSearch" placeholder="Find item..." onkeyup="filterMoveDropdown()">
            <select id="move-code"></select>
            <div style="display:flex; gap:10px;">
                <select id="move-type" style="flex:1;"><option value="IN">IN (+)</option><option value="OUT">OUT (-)</option></select>
                <input type="number" id="move-qty" placeholder="Qty" style="flex:1;" inputmode="numeric">
            </div>
            <button onclick="addToCart()">+ Add to List</button>
        </div>
        <div class="card" id="cartCard" style="display:none;">
            <h3>Batch Preview</h3>
            <div id="cartList" style="margin-bottom:15px; font-size:0.9rem;"></div>
            <button class="btn-post" onclick="processBatch()">Sync to Cloud</button>
        </div>
    </div>

    <div id="tab-hist" class="tab-content">
        <div class="card">
            <h2>Warehouse Activity</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <div id="tab-setup" class="tab-content">
        <div class="card" style="border: 2px solid var(--primary);">
            <h2>Warehouse Link</h2>
            <p style="font-size:0.8rem;">Warehouse ID (Share with Team):</p>
            <input type="text" id="warehouse-id-display" readonly style="background:#f8fafc; font-family:monospace; color:var(--primary);">
            <hr>
            <p style="font-size:0.8rem;">Join a Different Warehouse:</p>
            <input type="text" id="join-id-input" placeholder="Paste ID here">
            <button onclick="joinWarehouse()" style="background:#64748b;">Link Phone</button>
        </div>

        <div class="card">
            <h2>Profile</h2>
            <p id="user-display" style="font-size:0.85rem; margin-bottom:10px;"></p>
            <button onclick="firebase.auth().signOut()" style="background:var(--danger);">Logout</button>
        </div>

        <div class="card">
            <h2>Stock Import</h2>
            <input type="file" id="csvFile" accept=".csv">
            <button onclick="importCSV()" style="background:#64748b;">Upload CSV</button>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="switchTab('tab-dash', this)">Levels</div>
        <div class="nav-item" onclick="switchTab('tab-move', this)">Move</div>
        <div class="nav-item" onclick="switchTab('tab-hist', this)">Activity</div>
        <div class="nav-item" onclick="switchTab('tab-setup', this)">Setup</div>
    </div>

<script>
    const ADMIN_EMAIL = "nloost00@gmail.com";
    const firebaseConfig = {
      apiKey: "AIzaSyBUvFkq-IyvL4DhXYv_zODzqcEs-hmvxZI",
      authDomain: "my-inventory-e1eb4.firebaseapp.com",
      projectId: "my-inventory-e1eb4",
      storageBucket: "my-inventory-e1eb4.firebasestorage.app",
      messagingSenderId: "753821889716",
      appId: "1:753821889716:web:e377500d6ccb64586d53e1"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let currentWarehouseID = null;
    let inventory = [];
    let history = [];
    let cart = [];
    let unsubInv = null;
    let unsubHist = null;

    auth.onAuthStateChanged(async user => {
        if (user) {
            currentUser = user;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('user-display').innerText = "Logged in: " + user.email;
            
            const userDoc = await db.collection("users").doc(user.uid).get();
            currentWarehouseID = (userDoc.exists && userDoc.data().linkedWarehouse) ? userDoc.data().linkedWarehouse : user.uid;
            
            document.getElementById('warehouse-id-display').value = currentWarehouseID;
            if (user.email === ADMIN_EMAIL) document.getElementById('admin-indicator').style.display = 'inline';
            
            startDataListeners();
        } else {
            document.getElementById('auth-screen').style.display = 'flex';
        }
    });

    async function handleAuth() {
        const e = document.getElementById('auth-email').value;
        const p = document.getElementById('auth-pass').value;
        try { await auth.signInWithEmailAndPassword(e, p); } catch { await auth.createUserWithEmailAndPassword(e, p); }
    }

    async function joinWarehouse() {
        const id = document.getElementById('join-id-input').value.trim();
        if(id && confirm("Switch to this warehouse?")) {
            await db.collection("users").doc(currentUser.uid).set({ linkedWarehouse: id }, {merge:true});
            location.reload();
        }
    }

    function startDataListeners() {
        const path = db.collection("warehouses").doc(currentWarehouseID);
        if(unsubInv) unsubInv();
        unsubInv = path.collection("inventory").onSnapshot(snap => {
            inventory = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render(); filterMoveDropdown();
            document.getElementById('loading-screen').style.display = 'none';
        });

        if(unsubHist) unsubHist();
        unsubHist = path.collection("history").orderBy("timestamp", "desc").limit(20).onSnapshot(snap => {
            history = snap.docs.map(doc => doc.data());
            const nums = history.map(h => h.batchNum).filter(n => !isNaN(n));
            const lastNum = nums.length > 0 ? Math.max(...nums) : 1000;
            document.getElementById('nextBatchDisplay').innerText = "Batch #" + (lastNum + 1);
            renderHistory();
        });
    }

    async function processBatch() {
        if(cart.length === 0) return;
        const batchNum = parseInt(document.getElementById('nextBatchDisplay').innerText.split('#')[1]);
        const dbBatch = db.batch();
        const path = db.collection("warehouses").doc(currentWarehouseID);

        cart.forEach(entry => {
            const item = inventory.find(i => i.code === entry.code);
            const newQty = (entry.type === 'IN') ? (item.qty + entry.qty) : (item.qty - entry.qty);
            dbBatch.update(path.collection("inventory").doc(entry.code), { qty: newQty });
        });

        dbBatch.set(path.collection("history").doc(), {
            batchNum: batchNum,
            items: cart,
            date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' }),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            user: currentUser.email
        });

        await dbBatch.commit();
        cart = []; document.getElementById('cartCard').style.display = 'none';
        alert("Success: Batch #" + batchNum + " Synced.");
    }

    function render() {
        const tbody = document.getElementById('invTableBody');
        const q = document.getElementById('searchInput').value.toLowerCase();
        tbody.innerHTML = '';
        inventory.sort((a,b)=>a.code.localeCompare(b.code)).forEach(item => {
            if(item.code.toLowerCase().includes(q) || (item.desc && item.desc.toLowerCase().includes(q))) {
                const low = item.qty <= (item.min || 0);
                tbody.innerHTML += `<tr><td><strong>${item.code}</strong></td><td>${item.qty}</td><td><span style="color:${low?'red':'green'}">${low?'LOW':'OK'}</span></td></tr>`;
            }
        });
    }

    function renderHistory() {
        document.getElementById('historyList').innerHTML = history.map(h => `
            <div class="hist-group">
                <span class="user-tag">${h.user ? h.user.split('@')[0] : 'Admin'}</span>
                <div style="font-size:0.85rem; font-weight:bold; margin-bottom:5px;">Batch #${h.batchNum} <span style="font-weight:normal; font-size:0.7rem; color:#64748b;">• ${h.date}</span></div>
                ${h.items.map(i => `<div style="font-size:0.8rem;">• ${i.code}: ${i.type} ${i.qty}</div>`).join('')}
            </div>
        `).join('') || "<p style='text-align:center; color:#94a3b8;'>No recent activity.</p>";
    }

    function switchTab(t, el) {
        document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
        document.getElementById(t).classList.add('active'); el.classList.add('active');
    }

    function filterMoveDropdown() {
        const q = document.getElementById('moveSearch').value.toLowerCase();
        const select = document.getElementById('move-code');
        select.innerHTML = '<option value="">-- Select Item --</option>';
        inventory.filter(i => i.code.toLowerCase().includes(q) || (i.desc && i.desc.toLowerCase().includes(q))).forEach(item => {
            select.innerHTML += `<option value="${item.code}">${item.code}</option>`;
        });
    }

    function addToCart() {
        const c = document.getElementById('move-code').value;
        const t = document.getElementById('move-type').value;
        const q = parseInt(document.getElementById('move-qty').value);
        if(!c || !q) return;
        cart.push({ code: c, type: t, qty: q });
        document.getElementById('cartCard').style.display = 'block';
        document.getElementById('cartList').innerHTML = cart.map(i => `• ${i.code}: ${i.type} ${i.qty}`).join('<br>');
    }

    async function importCSV() {
        const file = document.getElementById('csvFile').files[0];
        const reader = new FileReader();
        reader.onload = async function(e) {
            const lines = e.target.result.split('\n');
            const path = db.collection("warehouses").doc(currentWarehouseID).collection("inventory");
            for(let line of lines) {
                const p = line.split(',');
                if(p.length >= 4 && p[0].trim().toUpperCase() !== "CODE") {
                    await path.doc(p[0].trim().toUpperCase()).set({ 
                        code: p[0].trim().toUpperCase(), desc: p[1].trim(), min: parseInt(p[2]) || 0, qty: parseInt(p[3]) || 0 
                    });
                }
            }
            alert("Inventory Overwritten Successfully.");
        };
        reader.readAsText(file);
    }
</script>
</body>
</html>
